generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

/* ===================== AUTH ===================== */

model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.String
  access_token      String? @db.String
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.String
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/* ===================== USER ===================== */

model User {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  name          String?
  email         String?  @unique
  emailVerified DateTime?
  image         String?
  password      String?
  country       String?
  phone         String?
  birthdate     String?
  role          Role     @default(DONOR)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  accounts  Account[]
  sessions  Session[]
  donations Donation[]
  comments  Comment[]
  cartItems CartItem[]
}

enum Role {
  ADMIN
  DONOR
}

/* ===================== CATEGORY ===================== */

model Category {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId

  // Arabic (default)
  name          String   @unique
  description   String?

  image         String?
  icon          String?
  order         Int?
  currentAmount Float    @default(0)

  campaigns     Campaign[]
  donationItems DonationCategoryItem[]
  translations  CategoryTranslation[]
}

model CategoryTranslation {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  categoryId String   @db.ObjectId
  locale     String   // en, fr, ...

  name        String
  description String?

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, locale])
}

/* ===================== HERO SLIDES ===================== */

model Slide {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String   // Arabic default
  description String?
  image       String?
  showButton  Boolean  @default(true)
  buttonText  String?
  buttonLink  String?
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  translations SlideTranslation[]
}

model SlideTranslation {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  slideId     String   @db.ObjectId
  locale      String
  title       String
  description String?
  buttonText  String?
  slide       Slide    @relation(fields: [slideId], references: [id], onDelete: Cascade)
  @@unique([slideId, locale])
}

/* ===================== CAMPAIGN ===================== */

model Campaign {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId

  // Arabic (default)
  title         String
  description   String

  targetAmount  Float
  currentAmount Float   @default(0)
  images        String[]
  videoUrl      String?
  isActive      Boolean @default(true)
  priority      Int?

  categoryId    String   @db.ObjectId
  category      Category @relation(fields: [categoryId], references: [id])

  updates       Update[]
  comments      Comment[]
  cartItems     CartItem[]
  donations     DonationItem[]
  translations  CampaignTranslation[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model CampaignTranslation {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  campaignId  String   @db.ObjectId
  locale      String   // en, fr, ...

  title       String
  description String

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, locale])
}

/* ===================== CAMPAIGN UPDATES ===================== */

model Update {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId

  // Arabic
  title       String
  description String

  image       String?
  videoUrl    String?

  campaignId  String   @db.ObjectId
  campaign    Campaign @relation(fields: [campaignId], references: [id])

  translations UpdateTranslation[]

  createdAt   DateTime @default(now())
}

model UpdateTranslation {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  updateId  String   @db.ObjectId
  locale    String

  title       String
  description String

  update Update @relation(fields: [updateId], references: [id], onDelete: Cascade)

  @@unique([updateId, locale])
}

/* ===================== DONATIONS ===================== */

model Donation {
  id              String             @id @default(auto()) @map("_id") @db.ObjectId
  amount          Float
  amountUSD       Float?
  currency        String             @default("USD")
  teamSupport     Float              @default(0)
  coverFees       Boolean            @default(false)
  fees            Float              @default(0)
  totalAmount     Float

  donorId         String             @db.ObjectId
  donor           User               @relation(fields: [donorId], references: [id])

  comment         String?
  type            DonationType       @default(ONE_TIME)
  status          SubscriptionStatus @default(ACTIVE)
  paymentMethod   PaymentMethod
  cardDetails     CardDetails?
  billingDay      Int?

  createdAt       DateTime @default(now())
  lastBillingDate DateTime?
  nextBillingDate DateTime?

  items           DonationItem[]
  categoryItems   DonationCategoryItem[]
  comments        Comment[]
}

model DonationItem {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  donationId String   @db.ObjectId
  campaignId String   @db.ObjectId

  amount     Float
  amountUSD  Float?

  donation Donation @relation(fields: [donationId], references: [id], onDelete: Cascade)
  campaign Campaign @relation(fields: [campaignId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DonationCategoryItem {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  donationId String   @db.ObjectId
  categoryId String   @db.ObjectId

  amount     Float
  amountUSD  Float?

  donation Donation @relation(fields: [donationId], references: [id], onDelete: Cascade)
  category  Category @relation(fields: [categoryId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum DonationType {
  ONE_TIME
  MONTHLY
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
}

enum PaymentMethod {
  CARD
  PAYPAL
}

type CardDetails {
  cardNumber     String
  expiryDate     String
  cvv            String
  cardholderName String
}

/* ===================== COMMENTS & CART ===================== */

model Comment {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  text       String

  userId     String   @db.ObjectId
  user       User     @relation(fields: [userId], references: [id])

  donationId String?  @db.ObjectId
  donation   Donation? @relation(fields: [donationId], references: [id])

  campaignId String   @db.ObjectId
  campaign   Campaign @relation(fields: [campaignId], references: [id])

  createdAt  DateTime @default(now())
}

model CartItem {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  campaignId String   @db.ObjectId
  userId     String   @db.ObjectId

  amount     Float
  amountUSD  Float?
  currency   String   @default("USD")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

/* ===================== POSTS ===================== */

model PostCategory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId

  // Arabic
  name      String   @unique
  title     String?
  description String?
  image     String?

  posts       Post[]
  translations PostCategoryTranslation[]

  createdAt DateTime @default(now())
}

model PostCategoryTranslation {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  categoryId  String   @db.ObjectId
  locale      String

  name        String
  title       String?
  description String?
  image       String?

  category PostCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, locale])
}

model Post {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId

  // Arabic
  title     String?
  description String?
  content   String?
  image     String?

  published Boolean @default(false)

  categoryId String? @db.ObjectId
  category   PostCategory? @relation(fields: [categoryId], references: [id])

  translations PostTranslation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PostTranslation {
  id      String   @id @default(auto()) @map("_id") @db.ObjectId
  postId  String   @db.ObjectId
  locale  String

  title       String?
  description String?
  content     String?
  image       String?

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, locale])
}

model LiveDonationTicker {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  isActive  Boolean  @default(true)
  
  // Donor names pool (will be randomly selected)
  donorNames String[] @default([])
  
  // Campaign names by locale
  // campaignNamesAr String[] @default([])
  // campaignNamesEn String[] @default([])
  // campaignNamesFr String[] @default([])
  
  // Amount ranges with probabilities
  amountRanges AmountRange[]
  
  // Display timing
  minIntervalSeconds Int @default(3)  // Minimum seconds between donations
  maxIntervalSeconds Int @default(8)  // Maximum seconds between donations
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

type AmountRange {
  minAmount    Float
  maxAmount    Float
  probability  Float  // Weight for this range (e.g., 70 for high, 20 for medium, 10 for low)
  label        String // e.g., "high", "medium", "low"
}
